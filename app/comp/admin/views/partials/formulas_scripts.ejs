<script>
    var ifdtobject;
    var nchar = 0;
    var resized = false;
    var formulasDB = <%- JSON.stringify(formula) %>;
    var objectConstructor = {}.constructor;

    console.log(formulasDB);

    function clickButton(id) {
        //alert('click');
        // TODO: Start spinner
        $('#spinner' + id).show();
        $('#resultUpdate' + id).empty();
        var $this = $('#' + id);
        console.log($this.attr('id'));
        var arrCallProm = $this.attr('id').split('__');
        var dataPost = {};
        dataPost[arrCallProm[0]] = arrCallProm[1];
        console.log('Call update critically: ' + JSON.stringify(dataPost));

        var tipoDeFormula = '';
        if (arrCallProm[0].indexOf('onditio') > -1) {
            tipoDeFormula = 'update_formulas_tracks_condition';
        } else if (arrCallProm[0].indexOf('AssetResponse') >= 0) {
            tipoDeFormula = 'update_formulas_tracks_response';

        } else if (arrCallProm[0].indexOf('AssetSensitivity') >= 0) {
            tipoDeFormula = 'update_formulas_tracks_sensitivity';

        } else {
            tipoDeFormula = 'update_formulas_tracks';
        }

        //console.log(tipoDeFormula + '---------------------------------------------');
        var p1 = $.ajax({
            url: '/auth/WEB/admin/' + tipoDeFormula + '/' + arrCallProm[0] + '/' + arrCallProm[1],
            data: JSON.stringify(dataPost),
            type: 'POST',
            contentType: 'application/json'
        }, function (data) { // console.log('koboinfo ' + JSON.stringify(data)); return (data);
        });
        Promise.all([p1]).then(function (values) {
            console.log(values);
            if (values[0].result === "OK") {
                // TODO: Stop spinner        
                $('#spinner' + id).hide();
                if (tipoDeFormula !== 'update_formulas_tracks_response' && tipoDeFormula !==
                    'update_formulas_tracks_sensitivity') {

                    $('#resultUpdate' + id).append('Tracks update: ' + values[0].tracksUpdated);
                } else {
                    $('#resultUpdate' + id).append('Tracks updated. Result: ' + values[0].result);

                }
                console.log(values[0].tracksUpdated);

            }
        });

    };
    $(document).ready(function () {


        // alert(featurePaintCriticality.publicThing);

        $.each(formulasDB, function (index, form) {
            //console.log(form.properties.HTML);
            $('#' + form.properties.HTML.id).on('click', function (event) {
                $this = $(this);
                //alert('AssetCriticality');
                $('#formulaName').empty();
                $('#selectFormula').empty();
                $('#formulaName').append(form.properties.HTML.text);
                // console.log(form.properties.HTML.id);
                switch ($this[0].id) {
                    case "AssetCondition":
                        $('#formulaSpec').empty();
                        $('#selectFormula').empty();
                        /*
                            Feature paint formula
                        */
                        featurePaintCondition.paintHTML(form);

                        $('input[type=radio][name=optionsRadios]').on('change', function () {
                            // alert(this.value);
                            var arrRadio = $('input[type=radio][name=optionsRadios]');
                            $.each(arrRadio, function (r, radio) {
                                console.log(r + ' ' + radio.value);
                                $('#formulaTable' + radio.value).hide();
                            });
                            var capa = '#formulaTable' + this.value;
                            $(capa).show();


                        });
                        var valant = '';
                        $('input[type=number]').on('focus', function () {
                            console.log(this.value);
                            // On first focus, check to see if we have the default text saved
                            // If not, save current value to data()
                            //if (!$(this).data('')) $(this).data('', $(this).val());

                            // check to see if the input currently equals the default before clearing it
                            valant = $(this).val();
                        });
                        $('input[type=number]').on('blur', function () {
                            // on blur, if there is no value, set the defaultText
                            if ($(this).val() != valant) {
                                // $(this).val($(this).data('defaultText'));
                                var dataPost = {};
                                dataPost[this.name] = this.value;
                                var $input = $(this);

                                console.log('New Val: ' + JSON.stringify(dataPost));

                                var p1 = $.ajax({
                                    url: '/auth/WEB/admin/update_field/' + this
                                        .name + '/' + this.value,
                                    data: JSON.stringify(dataPost),
                                    type: 'POST',
                                    contentType: 'application/json'
                                }, function (data) {
                                    console.log('koboinfo ' + JSON.stringify(
                                        data));
                                    return (data);
                                });
                                Promise.all([p1]).then(function (values) {
                                    console.log(values);
                                    if (values[0].result === "OK") {
                                        $input.css("border", "2px solid green");
                                    } else {
                                        $input.css("border", "2px solid red");
                                    }
                                });

                            }
                        });
                        this.name = '';
                        break;

                    case "AssetCriticality":
                        $('#formulaSpec').empty();
                        $('#selectFormula').empty();
                        /*
                            Feature paint formula
                        */
                        featurePaintCriticality.paintHTML(form);

                        $('input[type=radio][name=optionsRadios]').on('change', function () {
                            // alert(this.value);
                            var arrRadio = $('input[type=radio][name=optionsRadios]');
                            $.each(arrRadio, function (r, radio) {
                                console.log(r + ' ' + radio.value);
                                $('#formulaTable' + radio.value).hide();
                            });
                            var capa = '#formulaTable' + this.value;
                            $(capa).show();


                        });
                        var valant = '';
                        $('input[type=text]').on('focus', function () {
                            console.log(this.value);
                            // On first focus, check to see if we have the default text saved
                            // If not, save current value to data()
                            //if (!$(this).data('')) $(this).data('', $(this).val());

                            // check to see if the input currently equals the default before clearing it
                            valant = $(this).val();
                        });
                        $('input[type=text]').on('blur', function () {
                            // on blur, if there is no value, set the defaultText
                            if ($(this).val() != valant) {
                                // $(this).val($(this).data('defaultText'));
                                var dataPost = {};
                                dataPost[this.name] = this.value;
                                var $input = $(this);

                                console.log('New Val: ' + JSON.stringify(dataPost));

                                var p1 = $.ajax({
                                    url: '/auth/WEB/admin/update_field/' + this
                                        .name + '/' + this.value,
                                    data: JSON.stringify(dataPost),
                                    type: 'POST',
                                    contentType: 'application/json'
                                }, function (data) {
                                    // console.log('koboinfo ' + JSON.stringify(data));
                                    return (data);
                                });
                                Promise.all([p1]).then(function (values) {
                                    console.log(values);
                                    if (values[0].result === "OK") {
                                        $input.css("border", "2px solid green");
                                    } else {
                                        $input.css("border", "2px solid red");
                                    }
                                });

                            }
                        });
                        break;

                        // AssetResponse
                        /////////////////

                    case "AssetResponse":
                        $('#formulaSpec').empty();
                        $('#selectFormula').empty();
                        /*
                            Feature paint formula
                        */
                        featurePaintResponse.paintHTML(form);


                        var valant = '';
                        $('input[type=number]').on('focus', function () {
                            console.log(this.value);
                            // On first focus, check to see if we have the default text saved
                            // If not, save current value to data()
                            //if (!$(this).data('')) $(this).data('', $(this).val());

                            // check to see if the input currently equals the default before clearing it
                            valant = $(this).val();
                        });
                        $('input[type=number]').on('blur', function () {
                            // on blur, if there is no value, set the defaultText
                            if ($(this).val() != valant) {
                                // $(this).val($(this).data('defaultText'));
                                var dataPost = {};
                                dataPost['AssetResponse__' + this.name] = this.value;
                                var $input = $(this);

                                console.log('New Val: ' + JSON.stringify(dataPost));

                                var p1 = $.ajax({
                                    url: '/auth/WEB/admin/update_field/AssetResponse__' +
                                        this.name + '/' + this.value,
                                    data: JSON.stringify(dataPost),
                                    type: 'POST',
                                    contentType: 'application/json'
                                }, function (data) {
                                    // console.log('koboinfo ' + JSON.stringify(data));
                                    return (data);
                                });
                                Promise.all([p1]).then(function (values) {
                                    console.log(values);
                                    if (values[0].result === "OK") {
                                        $input.css("border", "2px solid green");
                                    } else {
                                        $input.css("border", "2px solid red");
                                    }
                                });

                            }
                        });
                        break;
                        // AssetSensitivity
                        /////////////////

                    case "AssetSensitivity":
                        $('#formulaSpec').empty();
                        $('#selectFormula').empty();
                        /*
                            Feature paint formula
                        */
                        featurePaintSensitivity.paintHTML(form);


                        var valant = '';
                        $('input[type=number]').on('focus', function () {
                            console.log(this.value);
                            // On first focus, check to see if we have the default text saved
                            // If not, save current value to data()
                            //if (!$(this).data('')) $(this).data('', $(this).val());

                            // check to see if the input currently equals the default before clearing it
                            valant = $(this).val();
                        });
                        $('input[type=number]').on('blur', function () {
                            // on blur, if there is no value, set the defaultText
                            if ($(this).val() != valant) {
                                // $(this).val($(this).data('defaultText'));
                                var dataPost = {};
                                dataPost['AssetSensitivity__' + this.name] = this.value;
                                var $input = $(this);

                                console.log('New Val: ' + JSON.stringify(dataPost));

                                var p1 = $.ajax({
                                    url: '/auth/WEB/admin/update_field/AssetSensitivity__' +
                                        this.name + '/' + this.value,
                                    data: JSON.stringify(dataPost),
                                    type: 'POST',
                                    contentType: 'application/json'
                                }, function (data) {
                                    // console.log('koboinfo ' + JSON.stringify(data));
                                    return (data);
                                });
                                Promise.all([p1]).then(function (values) {
                                    console.log(values);
                                    if (values[0].result === "OK") {
                                        $input.css("border", "2px solid green");
                                    } else {
                                        $input.css("border", "2px solid red");
                                    }
                                });

                            }
                        });
                        break;
                        // Likelihood
                        /////////////////

                    case "Likelihood":
                        $('#formulaSpec').empty();
                        $('#selectFormula').empty();
                        /*
                            Feature paint formula
                        */
                        featurePaintLikelihood.paintHTML(form);


                        var valant = '';
                        $('input[type=number]').on('focus', function () {
                            console.log(this.value);
                            // On first focus, check to see if we have the default text saved
                            // If not, save current value to data()
                            //if (!$(this).data('')) $(this).data('', $(this).val());

                            // check to see if the input currently equals the default before clearing it
                            valant = $(this).val();
                        });
                        $('input[type=number]').on('blur', function () {
                            // on blur, if there is no value, set the defaultText
                            if ($(this).val() != valant) {
                                // $(this).val($(this).data('defaultText'));
                                var dataPost = {};
                                dataPost['Likelihood__' + this.name] = this.value;
                                var $input = $(this);

                                console.log('New Val: ' + JSON.stringify(dataPost));

                                var p1 = $.ajax({
                                    url: '/auth/WEB/admin/update_field/Likelihood__' +
                                        this.name + '/' + this.value,
                                    data: JSON.stringify(dataPost),
                                    type: 'POST',
                                    contentType: 'application/json'
                                }, function (data) {
                                    // console.log('koboinfo ' + JSON.stringify(data));
                                    return (data);
                                });
                                Promise.all([p1]).then(function (values) {
                                    console.log(values);
                                    if (values[0].result === "OK") {
                                        $input.css("border", "2px solid green");
                                    } else {
                                        $input.css("border", "2px solid red");
                                    }
                                });

                            }
                        });
                        break;


                    default:
                        $('#formulaSpec').empty();
                        break;
                }

            });
        });


    });
</script>